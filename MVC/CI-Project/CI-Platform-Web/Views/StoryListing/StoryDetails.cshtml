@model CI_Project.Entities.ViewModels.StoryDetailsModel
@{
	ViewData["Title"] = "Story Details Page";
	var userId = Context.Session.GetString("UserId");
	var fullName = Context.Session.GetString("FullName");
}

@section Styles {
	<link rel="Stylesheet" href="@Href("~/css/story.css")" />
}


<main class="position-relative">
	<header id="header" class="border-2 border-bottom ci-page-header bg-white w-100 z-3"
			style="background-color: transparent;min-width: max-content;">
		<partial name="_Navbar"></partial>
		

	</header>

	<div id="scrollable-area" class="overflow-y-scroll">
		<div class="container" style="max-width:var(--max-width)">
			@*-------------------- Row-1 ----------------------*@
			<div class="row">

				@*-------------------- carousel ----------------------*@
				<div class="new-carousel col-lg-6 col-12 p-0">

					<div class="w-100 p-0 " style="height:600px;">

						@if (Model.Story?.StoryMedia?.Count() <= 1)
						{
							<input hidden id="carouselImagesCount" value="@Model.Story?.StoryMedia?.Count()" />

							@if (Model.Story?.StoryMedia?.Count() == 1)
							{
								<div class="p-2 w-100 h-100">
									<img id="carousal-preview-image" class="object-fit-cover w-100 h-100" src="@Model.Story?.CoverImage" />
								</div>
							}
							@if (Model.Story?.StoryMedia?.Count() == 0)
							{
								<div class="p-2 w-100 h-100">
									<img id="carousal-preview-image" class="object-fit-cover w-100 h-100" src="~/images//404-Page-image.png" />
								</div>
							}

						}
						else
						{
							<div class="p-2 w-100" style="height:calc(100% - 100px) !important;">
								<img id="carousal-preview-image" class="object-fit-cover w-100 h-100" src="@Model.Story?.CoverImage" />
							</div>

							<div class="d-flex position-relative m-2" style="height:100px !important;">
								<div id="carouselLeftShiftArrow">
									<img src="~/images/left1.png" />
								</div>
								<div class="small-images-div d-flex overflow-y-scroll" style="scroll-behavior:smooth;">
									<input hidden id="carouselImagesCount" value="@Model.Story?.StoryMedia?.Count()" />

									@foreach (var currStoryMedia in Model.Story?.StoryMedia!)
									{
										<img style="min-width:150px;" class="carousal-images-from-slider h-100 object-fit-cover" src="@currStoryMedia.Path@currStoryMedia.Type" />
									}
								</div>
								<div id="carouselRightShiftArrow">
									<img src="~/images/right-arrow2.png" />
								</div>
							</div>
						}


					</div>

				</div>

				@*-------------------- user-details-div ----------------------*@
				<div class="story-user-details-div col-lg-6 col-12  p-4 " style="max-height:600px;">

					@*-------------------- user-details ----------------------*@
					<div class="d-flex justify-content-between">

						<div id="user-profile-image-div" class="d-flex   h-100">
							<div style="min-width:max-content;">
								@if(Model.Story?.User?.Avatar != null){
								<img src="@Model.Story?.User?.Avatar" class="rounded-circle object-fit-fill" style="height:100px;width:100px;" />
								}
								else{
									<img src="~/images//404-Page-image.png" class="rounded-circle object-fit-fill" style="height:100px;width:100px;" />
								}
								<span class="d-flex align-items-center justify-content-center pt-2">@Model.User?.FirstName @Model.User?.LastName</span>
							</div>
						</div>
						<div class="d-flex align-items-end justify-content-end w-100">
							<span class="border border-2  px-3 d-flex align-items-center justify-content-center rounded-pill">
								<img src="~/images/eye.png" class="me-2" style="height:15px;width:30px;" />
								<span class="text-secondary" style="color:var(--border-color);min-width:max-content;">@Model.Story?.Views Views</span>
							</span>
						</div>

					</div>

					@*-------------------- why i volunteer ----------------------*@
					<div class="pt-4">
						@Html.Raw(Model.User?.WhyIVolunteer)
					</div>
					<input hidden id="userId" value="@userId" />
					<input hidden id="storyId" value="@Model.Story?.StoryId" />
					@*-------------------- recommend and open mission buttons ----------------------*@
					<div class="pt-4 d-flex flex-sm-row flex-column justify-content-between ">
						<button data-bs-target="#recommend-modal" id="recommend-button" class="mb-sm-0 mb-2 c-btn-primary bg-transparent btn btn-outline-primary text-secondary border border-2 border-secondary py-2 px-3 rounded-pill d-flex justify-content-center align-items-center gap-3">
							<img src="~/images/add1.png" />
							<span style="min-width:max-content;">Recommend to a Co-Worker</span>
						</button>
						<a asp-action="Index" asp-controller="VolunteeringMission" asp-route-id="@Model.Story?.MissionId" class="c-btn-warning bg-transparent text-decoration-none text-warning border border-2 border-warning py-2 px-3 rounded-pill d-flex justify-content-center align-items-center gap-3">
							<span style="min-width:max-content;"> Open Mission </span>
							<img src="~/images/right-arrow.png" />
						</a>
					</div>

				</div>
			</div>

			@*-------------------- Row-2 ----------------------*@
			<div class="row pt-4">
				<div class="py-2 border-2 border-bottom">
					<span class="story-details-title p-0 m-0 fs-3  text-decoration-underline" style="text-underline-offset:17px;text-decoration-thickness:5px;">
						@Html.Raw(Model.Story?.StoryTitle)
					</span>
				</div>
				<div class="story-details-description">
					@Html.Raw(Model.Story?.StoryDescription)
				</div>

			</div>

			<div id="recommend-partial">
			</div>
		</div>
	</div>



	<partial name="_Footer"></partial>
</main>

@section Scripts{
	<script>
		let userId = document.getElementById('userId').value;
		let storyId = document.getElementById('storyId').value;
		console.log("user:" + userId);
		let userIds = [];
		// ------------------------ recommend ------------------------
		$('#recommend-button').on("click", () => {
			console.log("recommend");

			$.ajax({
				url: "/StoryListing/getAllUsersForRecommendingStory",
				method: "GET",
				dataType: "html",
				data: { "userId": userId },
				success: function (data) {

					$('#recommend-partial').html(data);
					$('#recommend-modal').modal("show");

					$('#send-recommendation').on('click', () => {
						getCheckedUsersId();
						$('#recommend-modal').modal("hide");

							Swal.fire({
								position: 'top-end',
								icon: 'success',
								title: 'Story Recommendation is sent to your colleagues!',
								showConfirmButton: false,
								timer: 2000
							});


						$.ajax({
							url: "/StoryListing/addDataToStoryInvite",
							method: "POST",
							dataType: "html",
							data: { "userIdList": userIds, "storyId": storyId, "userId": userId },
							success: function (data) {
								
							},
							error: function (error) {
								console.log(error);
							}
						});

					});
				},
				error: function (error) {
					console.log(error);
				}
			});
		});

		function getCheckedUsersId() {
			var checkedUsers = document.querySelectorAll('#userChkBox:checked').forEach(val => {
				var selectedUserId = $(val).val();
				userIds.push(selectedUserId);
			})
		}
	</script>
	<script src="~/js/tiny.js"></script>
	<script src="~/js/headerSidebar.js"></script>
	<script src="~/js/scrolable.js"></script>
	<script src="~/js/carouselImageChanger.js"></script>
}