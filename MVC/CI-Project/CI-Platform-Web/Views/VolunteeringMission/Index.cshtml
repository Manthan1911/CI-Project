@model CI_Project.Entities.ViewModels.VolunteeringMissionModel

@{
	ViewData["Title"] = "Volunteering Mission";
	var GoalMissionCtx = @Model.MissionModel.GoalMissions.FirstOrDefault(m => m.MissionId == Model.MissionModel.MissionId);
	var isMissionFavourite = 0;
	if (Model.user.UserId != 0)
	{
		if (Model.MissionModel.FavouriteMissions.Any(favMission => favMission.UserId == Model.user.UserId))
		{
			isMissionFavourite = 1;
		}

	}
}

@section Styles {
	<link rel="Stylesheet" href="@Href("~/css/volunteeringMission.css")" />
}
<main class="position-relative">
	<header id="header" class="ci-page-header bg-white w-100 z-3"
			style="background-color: transparent;min-width: max-content;">
		<div id="header-profile" class="mx-auto d-flex align-items-center justify-content-between"
			 style="max-width:var(--max-width);height:var(--header-height);background-color: transparent;">
			<div class="ci-page-header-left-div d-flex ">
				<div class="p-2 h-100 d-sm-none">
					<button id="header-sidebar-open-btn" class="bg-transparent sidebar-open border-0">
						<img src="/images/list.png" alt="">
					</button>
				</div>
				<a asp-action="Index" asp-controller="Home"><img id="logo" class=" mx-2" src="~/images/logo.png" alt=""></a>
				<div id="header-sidebar" class=" d-sm-flex flex-row align-items-center justify-content-center">
					<div id="close-btn-div" class="p-2">
						<button id="header-sidebar-close"
								class="sidebar-close d-sm-none d-flex  justify-content-center p-2 bg-transparent border-0">
							<img src="./images/cancel1.png" alt="">
						</button>
					</div>
					<div id="stories-div" class="p-2">
						<a class="text-decoration-none text-black mx-2" asp-action="Index" asp-controller="StoryListing">
							Stories
						</a>
					</div>

					<div id="policy-div" class="dropdown mx-2">
						<button class="bg-transparent border-0 p-0 dropdown-toggle" type="button"
								data-bs-toggle="dropdown" aria-expanded="false">
							Policy
							<img class="mx-1" src="./images/drop-down.png" alt="">
						</button>
						<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
							<li><a class="dropdown-item" href="#">Action</a></li>
							<li><a class="dropdown-item" href="#">Another action</a></li>
							<li><a class="dropdown-item" href="#">Something else here</a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="ci-page-header-profile-div p-1 mx-1 d-flex" style="min-width: max-content;">
				<div class="dropdown mx-2 px-sm-0 px-2">
					<button class="bg-transparent d-flex justify-content-center align-items-center border-0 p-0 py-1 dropdown-toggle" type="button"
							id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
						<div href="">
							<img class="ci-page-header-profile-img mx-1"
								 style="border-radius: 50%;height: 40px;width: 40px;object-fit: cover;"
								 src="~/images/user-img.png" alt="user-img">
						</div>
						<div class="d-md-block d-none">
							<span class="ci-page-header-profile-name mx-1 py-1">
								@Model.user.FirstName @Model.user.LastName
							</span>
							<img src="./images/drop-down.png" alt="">
						</div>
					</button>
					<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
						<li id="logoutBtn"><a class="dropdown-item" href="#">logout</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div id="scrollable-area" class="overflow-y-scroll ">
		<div id="main-container" class="container mt-4 mb-2 mb-sm-4">

			<div id="volunteer-mission-apply " class="row d-flex flex-column flex-lg-row">
				<div id="volunteer-mission-apply-mission-photos" class="col-12 col-lg-6">
					<img id="carousal-preview-image"
						 src="~/images/CSR-initiative-stands-for-Coffee--and-Farmer-Equity-4.png"
						 class="w-100 object-fit-contain volunteer-main-image" alt="" style="height:calc(100% - 120px);">
					<!-- carousel -->
					<div id="carouselExampleControls" class="carousel slide border border-2 border-primary w-100 my-1"
						 style="height: 120px;" data-bs-interval="false">
						<div class="carousel-inner h-100 w-100">
							<div class="carousel-item active h-100 w-100">
								<div class="d-flex h-100 w-100">
									<div class="h-100 w-100">
										<img src="~/images/CSR-initiative-stands-for-Coffee--and-Farmer-Equity-4.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/img1.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/Grow-Trees-On-the-path-to-environment-sustainability-1.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/img11.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
								</div>
							</div>
							<div class="carousel-item h-100 w-100">
								<div class="d-flex h-100 w-100">
									<div class="h-100 w-100">
										<img src="~/images/CSR-initiative-stands-for-Coffee--and-Farmer-Equity-4.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/img1.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/Grow-Trees-On-the-path-to-environment-sustainability-1.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
									<div class="h-100 w-100">
										<img src="~/images/img11.png"
											 class="carousal-images-from-slider d-block w-100 h-100 px-1" alt="..." />
									</div>
								</div>
							</div>



						</div>
						<button class="carousel-control-prev bg-dark" type="button"
								data-bs-target="#carouselExampleControls" data-bs-slide="prev">
							<span class="carousel-control-prev-icon" aria-hidden="true"></span>
							<span class="visually-hidden">Previous</span>
						</button>
						<button class="carousel-control-next bg-dark" type="button"
								data-bs-target="#carouselExampleControls" data-bs-slide="next">
							<span class="carousel-control-next-icon" aria-hidden="true"></span>
							<span class="visually-hidden">Next</span>
						</button>
					</div>
				</div>
				<div id="volunteer-mission-apply-details"
					 class=" col-12 col-lg-6 d-flex flex-column justify-content-between">

					<div id="mission-title-div" class="px-3">
						<div id="mission-title" class="fs-2">@Model.MissionModel.Title</div>
						<div id="mission-description" class="pb-4">
							@Model.MissionModel.ShortDescription
						</div>
					</div>
					<div class=" position-relative">
						@if (Model.MissionModel.MissionType.Equals("time"))
						{
							<div id="mission-theme"
							 class="d-flex align-items-center justify-content-center position-absolute w-100 z-1">
								<p class="bg-white  rounded-5 py-1 px-4 border border-2" style="margin-top:-20px;">
									From @Model.MissionModel.StartDate To @Model.MissionModel.EndDate
								</p>
							</div>
							<div id="mission-details-div"
							 class="border-top d-flex align-items-center justify-content-between position-relative">

								<div id="seats-left-div" class="d-flex align-items-center justify-content-center py-2 w-50">
									<img src="~/images/Seats-left.png" alt="" style="height:35px;width:35px;">
									<div class="d-flex justify-content-center flex-column px-2">
										<span class="fs-4 fw-semibold">@Model.MissionModel.seatsLeft</span>
										<span style="min-width: max-content;">Seats Left</span>
									</div>
								</div>
								<div id="mission-progress-div" class="d-flex align-items-center justify-content-center p-2 w-50 ">
									<img src="~/images/achieved.png" alt="" style="height:35px;width: 35px;">
									<div class="d-flex justify-content-center flex-column px-2">
										<span class="fs-4 fw-semibold">@Model.MissionModel.StartDate</span>
										<span style="min-width: max-content;">Deadline</span>
									</div>
								</div>

							</div>
						}
						else
						{
							<div id="mission-theme"
							 class="d-flex align-items-center justify-content-center position-absolute w-100 z-1">
								<p class="bg-white  rounded-5 py-1 px-4 border border-2" style="margin-top:-20px;">@GoalMissionCtx?.GoalObjectiveText</p>
							</div>
							<div id="mission-details-div"
							 class="border-top d-flex align-items-center justify-content-between position-relative">

								<div id="seats-left-div" class="d-flex align-items-center justify-content-center py-2 w-50">
									<img src="~/images/Seats-left.png" alt="" style="height:35px;width:35px;">
									<div class="d-flex justify-content-center flex-column px-2">
										<span class="fs-4 fw-semibold">@Model.MissionModel.seatsLeft</span>
										<span style="min-width: max-content;">Seats Left</span>
									</div>
								</div>
								<div id="mission-progress-div" class="d-flex justify-content-center p-2 w-50 ">
									<img src="~/images/achieved.png" alt="" style="height:35px;width: 35px;">
									<div class="d-flex flex-column px-2 ">
										<div class="progress ">
											<div class="progress-bar w-75" role="progressbar" aria-valuenow="75"
											 aria-valuemin="0" aria-valuemax="100"></div>
										</div>
										<span>8000 achieved</span>
									</div>
								</div>

							</div>
						}

						@*here*@
					</div>
					<div id="mission-favourite-recomend-div"
						 class="d-flex flex-column flex-sm-row justify-content-sm-around justify-content-center border-top py-4">
						<div class="d-flex align-items-center justify-content-sm-start justify-content-center pb-sm-0 pb-2">
							@if (isMissionFavourite == 1)
							{
								<button id="addToFav" class="bg-transparent py-2 px-4  rounded-5 d-flex align-items-center justify-content-center"
									style="min-width: max-content;">
									<img id="favImg" class="px-1" src="~/images/red-heart.png" style="height:20px;width:30px;" alt="">
									<span id="favText">Remove from Favourite</span>
								</button>
								<input type="hidden" id="isFavourite" value="@isMissionFavourite" />
							}
							else
							{
								<button id="addToFav" class="bg-transparent py-2 px-4  rounded-5 d-flex align-items-center justify-content-center"
									style="min-width: max-content;">
									<img id="favImg" class="px-1" src="~/images/heart1.png" style="height:20px;width:30px;" alt="">
									<span id="favText">Add to Favourite</span>
								</button>
								<input type="hidden" id="isFavourite" value="@isMissionFavourite" />
							}
						</div>
						<div class=" d-flex align-items-center justify-content-sm-end justify-content-center">
							<button data-bs-target="#recommend-modal" id="recommend-button" class="bg-transparent py-2 px-4 rounded-5 d-flex align-items-center "
									style="min-width: max-content;">
								<img class="px-1" src="~/images/add1.png" alt="">
								Recommend to Co-Worker
							</button>
						</div>
						<div id="recommend-partial">
						</div>
					</div>

					<div id="mission-related-information-div" class="position-relative border-top py-4 d-flex justify-content-around gap-2 ">
						<div id="rating" class="position-absolute z-1 d-flex justify-content-center align-items-center w-100" style="margin-top:-45px;">
							<div class="bg-white rounded-pill ">
								<input id="star-input-id" type="text" class="rating  d-none" data-size="sm">
							</div>
						</div>

						<div class="d-flex flex-column justify-content-between p-2 rounded-2 w-100"
							 style="border:1px solid black;">
							<div>
								<img src="~/images/pin1.png" class="py" alt="">
							</div>
							<div class="d-flex flex-column pe-3">
								<span>City</span>
								<span>@Model.MissionModel.City.Name</span>
							</div>
						</div>

						<div class="d-flex flex-column justify-content-between p-2 rounded-2 w-100"
							 style="border:1px solid black;">
							<div>
								<img src="~/images/web.png" class="py" alt="">
							</div>
							<div class="d-flex flex-column pt-2 pe-2">
								<span>Theme</span>
								<span>@Model.MissionModel.Theme.Title</span>
							</div>
						</div>

						<div class="d-flex flex-column justify-content-between p-2 rounded-2 w-100"
							 style="border:1px solid black;">
							<div>
								<img src="~/images/calender.png" class="py" alt="">
							</div>
							<div class="d-flex flex-column">
								<span>Date</span>
								<span>Ongoing<br>Opportunity </span>
							</div>
						</div>

						<div class="d-flex flex-column justify-content-between p-2 rounded-2 w-100"
							 style="border:1px solid black;">
							<div>
								<img src="~/images/organization.png" class="py" alt="">
							</div>
							<div class="d-flex flex-column pt-3 pe-2">
								<span>Organization</span>
								<span>@Model.MissionModel.OrganizationName</span>
							</div>
						</div>

					</div>
					<div id="mission-applyNow-div" class=" d-flex justify-content-center py-2">
						<button id="apply-button" class="apply-btn warning-btn bg-transparent rounded-5 py-3 px-5 d-flex align-items-center">
							Apply Now
							<img src="~/images/right-arrow.png" class="mx-2" alt="">
						</button>
					</div>

				</div>
			</div>

			<div id="volunteer-information" class="d-flex flex-lg-row flex-column  pt-3">
				<div id="volunteer-info-tabs" class=" border-warning p-2  h-100">
					<!-- Tab links -->
					<div class="tab">
						<button class="tablinks p-2 p-sm-4" onclick="openCity(event, 'Mission')">
							Mission
						</button>
						<button class="tablinks p-2 p-sm-4" onclick="openCity(event, 'Organization')">
							Organization
						</button>
						<button class="tablinks p-2 p-sm-4" onclick="openCity(event, 'Comments')">
							Comments
						</button>
					</div>

					<!-- Tab content -->
					<div id="Mission" class="tabcontent border-0">
						<h3>Introduction</h3>
						@Html.Raw(Model.MissionModel.Description)

						@*<h3>Documents</h3>
						<div class="">
						<button class="border border-1 rounded-5 px-3 py-2 bg-white mx-2">
						<img src="images/doc.png" class="px-2" alt="">lorem-ipsum.pdf
						</button>
						<button class="border border-1 rounded-5 px-3 py-2 bg-white mx-2">
						<img src="images/doc.png" class="px-2" alt="">at_vero_eos_accusamus.doc
						</button>
						<button class="border border-1 rounded-5 px-3 py-2 bg-white mx-2">
						<img src="images/doc.png" class="px-2" alt="">important_doc.xls
						</button>
						</div>*@
					</div>

					<div id="Organization" class="tabcontent border-0 p-0 pt-2">
						<h3>Organization</h3>
						@Html.Raw(Model.MissionModel.OrganizationDetails)
					</div>

					<div id="Comments" class="tabcontent border-0">
						<textarea id="commentText" class="w-100 rounded-2 p-1" placeholder="Enter your comments.."
								  rows="4" name=""></textarea>
						<button id="post-comment-btn" class="warning-btn apply-btn py-2 px-4 my-2 rounded-5 bg-transparent">
							Post comment
						</button>
						<div id="volunteer-comments-div" class="rounded-3">
							@*comments here*@
						</div>
					</div>
				</div>
				<div id="volunteer-recent-info"
					 class=" border-warning d-flex mx-5 flex-column justify-content-between h-100 ">
					<div id="volunteer-information-div" class="container border  px-3 py-2">
						<div class="p-2 px-0">
							<span class="hover-underline p-2 px-0 fs-5">
								Information
							</span>
						</div>
						<div class="row m-1 p-2">
							<div class="col-3"><span>skills</span></div>
							<div id="skillsList" class="col-9">
								@foreach (var currSkill in Model.MissionModel.MissionSkills)
								{
									<span>@currSkill.Skill.SkillName,</span>
								}
							</div>
						</div>
						<div class="row m-1 p-2">
							<div class="col-3"><span>Days</span></div>
							<div class="col-9"><span>@Model.MissionModel.Availability</span></div>
						</div>
						<div class="row m-1 p-2">
							<div class="col-3"> Rating </div>
							<div class="col-9">
								@for (var i = 1; i <= 5; i++)
								{
									if (i <= Model.MissionModel.avgRating)
									{
										<img src="~/images/selected-star.png" alt="selected-star">
									}
									else
									{
										<img src="~/images/star.png" alt="unselected-star">
									}
								}
								<span>(by @Model.MissionModel.countOfRatingsByPeople volunteers)</span>
							</div>
						</div>
					</div>

					<div id="recent-volunteers-div" class="border border-1">
						@*Recent Volunteers here*@
					</div>

				</div>
			</div>

			<div id="related-missions" class="w-100">
			</div>
		</div>
	</div>

	<footer id="footer" class="bottom-0 left-0 bg-white">
		<div class="mx-auto bg-white h-100 w-100 d-flex align-items-center " style="max-width:var(--max-width)">
			<a href="./privacy.html" class="text-decoration-none text-dark p-2">
				Privacy Policy
			</a>
		</div>
	</footer>
</main>

@section Scripts{
	<script>

		let userId = @Model.user.UserId;
		let missionId = @Model.MissionModel.MissionId;
		let isMissionFavourite = document.getElementById("isFavourite").value;

		//let isMissionFavourite = false;


		let pageNo = 1;
		let pageSize = 4;
		let userIds = [];

		$(document).ready(() => {
			let starInput = $("#star-input-id");
			let favouriteBtn = $('#addToFav');
			addStar(starInput, userId, missionId);


			addToFavourites(favouriteBtn, userId, missionId);

			let lastSkill = document.getElementById("skillsList").children[document.getElementById("skillsList").children.length - 1];
			lastSkill.innerHTML = lastSkill.innerHTML.split(',')[0];
			getComments(userId, missionId);

			getRecentVolunteers(missionId, pageNo, pageSize);
			postComment(userId, missionId);
			getAllRelatedMissions();

			// ------------------------ recommend
			$('#recommend-button').on("click", () => {
				console.log("recommend");

				$.ajax({
					url: "/VolunteeringMission/getAllUsers",
					method: "GET",
					dataType: "html",
					data: { "missionId": missionId, "userId": userId },
					success: function (data) {

						$('#recommend-partial').html(data);
						$('#recommend-modal').modal("show");

						$('#send-recommendation').on('click', () => {
							getCheckedUsersEmail();
							$('#recommend-modal').modal("hide");

							$.ajax({
								url: "/VolunteeringMission/addToMissionInvite",
								method: "POST",
								dataType: "html",
								data: { "userEmailList":userIds , "missionId": missionId, "userId": userId },
								success: function (data) {

								},
								error: function (error) {
									console.log(error);
								}
							});
							
						});
					},
					error: function (error) {
						console.log(error);
					}
				});
			});
		});

		function getCheckedUsersEmail() {
			var checkedUsers = document.querySelectorAll('#userChkBox:checked').forEach(val => {
				var selectedUserId = $(val).val();
				userIds.push(selectedUserId);
			})
		}

		function addStar(starInput, userId, missionId) {
			$("#rating .rating-stars").on("click", function (event) {
				var starRating = Math.ceil(parseFloat(starInput.val()));
				$.ajax({
					type: "POST",
					url: '/VolunteeringMission/postRating',
					data: { userId: userId, missionId: missionId, rating: starRating },
					success: function (data) {
						alert("You rated this mission " + starRating + " star !");
					}
				});
			});
		}

		function addToFavourites(favouriteBtn, userId, missionId) {
			console.log("add clicked");
			$('#addToFav').on("click", function (favouriteBtn) {
				console.log(isMissionFavourite);
				if (isMissionFavourite == 1) {
					$.ajax({
						type: "POST",
						url: '/VolunteeringMission/removeFromFavourite',
						data: { userId: userId, missionId: missionId },
						success: function (data) {
							document.getElementById("favImg").src = "/images/heart1.png";
							document.getElementById("favText").innerHTML = "Add To Favourite";
							isMissionFavourite = 0;
							alert("mission removed from favourites !");
						}
					});
				}
				else if (isMissionFavourite == 0) {
					$.ajax({
						type: "POST",
						url: '/VolunteeringMission/addToFavourite',
						data: { userId: userId, missionId: missionId },
						success: function (data) {
							document.getElementById("favImg").src = "/images/red-heart.png";
							document.getElementById("favText").innerHTML = "Remove From Favourites";
							isMissionFavourite = 1;
							alert("mission added to favourites !");
						}
					});
				}
			});
		}

		function postComment(userId, missionId) {
			$('#post-comment-btn').on("click", () => {
				console.log("post clicked;");
				let commentText = $('#commentText').val().trim();
				console.log("text .. " + commentText);
				if (commentText != "") {
					$.ajax({
						type: "POST",
						url: '/VolunteeringMission/postComment',
						data: { userId: userId, missionId: missionId, commentText: commentText },
						success: function (data) {
							document.getElementById('commentText').value = ""; 
							getComments(userId, missionId);
						}
					});
				}
				else {
					alert("comment text is null");
				}
			});
		}
		function getComments(userId, missionId) {
			$.ajax({
				type: "GET",
				url: '/VolunteeringMission/loadAllComments',
				data: { missionId: missionId },
				success: function (data) {
					$('#volunteer-comments-div').html('');
					$('#volunteer-comments-div').html(data);
				}
			});
		}
		// ------------------------------------------- Recent Volunteers Pagination ------------------------------------------------


		function addListnerToRecentVolunteers() {
			let leftShift = document.getElementById("left-shift");
			let rightShift = document.getElementById("right-shift");
			let totalVolunteers = +document.getElementById("totalVolunteers").value;
			console.log("total volunteers : " + totalVolunteers);
			let maxPage = Math.ceil(totalVolunteers / pageSize);
			leftShift.addEventListener("click", () => {
				if (pageNo > 1) {
					pageNo -= 1;
					getRecentVolunteers(missionId, pageNo, pageSize);
				}
				console.log("pageNo : " + pageNo);
			});

			rightShift.addEventListener("click", () => {
				if (pageNo < maxPage) {
					pageNo += 1;
					getRecentVolunteers(missionId, pageNo, pageSize);
				}
				console.log("pageNo : " + pageNo);
			});
		}

		function getRecentVolunteers(missionId, pageNo, pageSize) {
			$.ajax({
				type: "GET",
				url: '/VolunteeringMission/getRecentVolunteers',
				data: { missionId: missionId, pageNo: pageNo, pageSize: pageSize },
				success: function (data) {
					$('#recent-volunteers-div').html('');
					$('#recent-volunteers-div').html(data);

					addListnerToRecentVolunteers();
				}
			});
		}

		//-------------------------------- Related Missions --------------------------------
		function getAllRelatedMissions() {
			$.ajax({
				type: "GET",
				url: '/VolunteeringMission/getAllRelatedMissions',
				data: { "missionId": missionId, "userId": userId },
				success: function (data) {
					$('#related-missions').html('');
					$('#related-missions').html(data);
					toggleAddToFavouriteButton();
				}
			});
		}

		//----------------------------------- ad to fav and remove from fav ----------------------------------------
		function toggleAddToFavouriteButton() {
			$('.fav-mission-id').on('click', function () {
				let missionId = $(this).children(0).attr("data-id");

				$.ajax({
					url: "/Home/addOrRemoveFavourite",
					method: "POST",
					dataType: "html",
					data: { "missionId": missionId },
					success: function (data) {
						getAllRelatedMissions();
					},
					error: function (error) {
						console.log(error);
					}
				});
			});
		}



	</script>
	<script src="~/js/headerSidebar.js"></script>
	<script src="~/js/scrolable.js"></script>
	<script src="~/js/volunteeringInfo.js"></script>
}